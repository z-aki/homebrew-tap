name: brew test-bot

permissions:
  contents: write
on:
  workflow_dispatch:

jobs:
  test-bot:
    strategy:
      matrix:
        # One runner for Darwin 24 (Sequoia), one for Darwin 26 (Tahoe)
        os: [macos-15, macos-26]
    runs-on: ${{ matrix.os }}
    outputs:
      next_tag: ${{ steps.build.outputs.next_tag }}
    steps:
      - name: test-bot Checkout your tap
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: test-bot Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@main

      - name: test-bot Fetch and Patch
        run: |
          mkdir -p Formula
          curl -L https://github.com/Homebrew/homebrew-core/raw/refs/heads/main/Formula/e/emacs.rb -o Formula/emacs.rb
          patch Formula/emacs.rb native.patch

      - name: test-bot Build Bottle
        id: build
        run: |
          latest_tag=$(git tag --list 'v*' | sort -V | tail -n1)
          if [[ -z "$latest_tag" ]]; then next_tag="v1"; else
            next_num=$(( ${latest_tag#v} + 1 )); next_tag="v$next_num";
          fi
          echo "next_tag=$next_tag" >> "$GITHUB_OUTPUT"

          # This merge combines Sequoia and Tahoe hashes into the same file
          root_url="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/releases/download/$next_tag/"
          brew install --build-bottle z-aki/tap/emacs
          brew bottle --root-url "$root_url" --json z-aki/tap/emacs

      - name: test-bot Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bottles-${{ matrix.os }}
          path: |
            *.bottle.json
            *.bottle*.tar.gz
            Formula/emacs.rb

  publish:
    needs: test-bot
    runs-on: macos-15
    steps:
      - name: Checkout your tap
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@main

      - name: Download all bottles
        uses: actions/download-artifact@v4
        with:
          pattern: bottles-*
          merge-multiple: true

      - name: Merge Bottles and Push
        run: |
          git config user.name "z-aki"
          git config user.email "39851968+z-aki@users.noreply.github.com"
          
          brew bottle --merge --write ./emacs*.json || true
          git tag "${{ needs.test-bot.outputs.next_tag }}"
          git push origin main --tags

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.test-bot.outputs.next_tag }}
          name: ${{ needs.test-bot.outputs.next_tag }}
          body: "Release ${{ needs.test-bot.outputs.next_tag }}"
          files: |
            *.bottle*.tar.gz
            *.bottle.json